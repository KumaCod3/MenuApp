<div class="container-fluid container-wide">
	<div class="row">
		<div class="col-md-8">

			<button id="dwnMENU" class="btn btn-secondary mb-3">Scarica LISTA</button>
			<button id="genMENU" class="btn btn-secondary mb-3">Genera MENU</button>
			<button id="LoadMenu" class="btn ricetta-cena mb-3">Carica Menu</button>
			<button id="Save" class="btn ricetta-pranzo mb-3">SALVA MODIFICHE</button>
			<button id="fresh" class="btn ricetta-pranzo mb-3">libera Ricette</button>
			<h2 class="display-4">Ecco il tuo menu</h2>
			<p>
				<h3 id="intestazione">Name per l'Temperatura</h3>
			</p>

			<div id="contenitoreMenu">
			</div>
			<div id="contenitoreLista">
			</div>

		</div>
		<div class="col-md-4">
			<div class="sticky-top pt-4 sidebar-viewport">
				<div class="p-3 border bg-light rounded full-height-box">
					<h2 id="sid">Ricette da Usare <span class="btn ricetta-unisex counter" id="counter-value">0</span></h2>
					<hr class="hrB">
					<div id="sidecar" data-map="-1">
						Qui puoi inserire il nuovo contenuto che volevi affiancare.<br /><br />
						bla bla..<br /><br />


					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>

	document.addEventListener("DOMContentLoaded", (event) => {
		const url = window.location.pathname;
		const segments = url.split('/');
		idSettima = segments.pop();
		caricaTavola(idSettima);
	});
	var titoloMenu = "";
	var questaSettimana = "";
	var idSettima = "";
	var idMenu = "";
	var sidecarCounter = 0;
	var counterSpan = document.getElementById("counter-value");
	const mappaRicette = new Map();
	var map = 0;

	async function caricaTavola(idSettima) {
		try {
			const recipeData = {
				iddi: idSettima,
			};
			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(recipeData),
				headers: { "Content-Type": "application/json" }
			};
			const response = await fetch("/loadSettimana", fetchConfigData);
			if (response.ok) {
				const settimana = await response.json();
				idMenu = settimana.Menu;
				titoloMenu = await cercaNomeMenu();
				caricaPitStop();
				questaSettimana = settimana;
				var div = document.getElementById("intestazione");
				div.innerHTML = div.innerHTML.replace("Name", `${titoloMenu} - ${settimana.Name} `);
				var temper = "";
				name = settimana.Name;
				switch (settimana.Temperatura) {
					case 1:
						temper = 'Estate';
						break;
					case 2:
						temper = 'Inverno';
						break;
					default:
						temper = 'OgniStagione';
				}
				div.innerHTML = div.innerHTML.replace("Temperatura", temper);
				loadTableWithMenus(settimana);
				
			} else {
				console.log("Error with the response data");
			}
		} catch (err) {
			console.log(`Error: ${err}`);
		}
	}

	// helper DOWNLOAD
	function popolaLista(dati) {
		const container = document.getElementById("contenitoreLista");
		container.innerHTML = "";
		if (dati.length === 0) {
			container.innerHTML = "<p>Nessun Ingrediente.</p>";
			return;
		}
		dati.forEach(ingred => {
			container.innerHTML += `<p> ${ingred} </p>`;
		});
	}

	// helper DOWNLOAD
	function contaRipetizioni(arrayIniziale) {
		const conteggio = {};
		arrayIniziale.forEach(str => {
			conteggio[str] = (conteggio[str] || 0) + 1;
		});

		const arrayFinale = [];
		for (const [str, count] of Object.entries(conteggio)) {
			if (count > 1) {
				arrayFinale.push(`${count} ${str}`);
			} else {
				arrayFinale.push(str);
			}
		}
		return arrayFinale;
	}

	// helper caricaTavola
	async function cercaNomeMenu() {
		try {
			const recipeData = {
				id: idMenu
			};
			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(recipeData),
				headers: { "Content-Type": "application/json" }
			};
			const response = await fetch("/MenuID", fetchConfigData);

			if (response.ok) {
				const data = await response.json();
				console.log("Dati ricevuti dal server:", data);
				return data.Name;
			}
		} catch (err) {
			console.error("Errore durante il download:", err);
			alert("Impossibile generare menu: " + err.message);
		}
	}

	async function caricaPitStop() {
		try {
			const recipeData = {
				id: idMenu
			};
			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(recipeData),
				headers: { "Content-Type": "application/json" }
			};
			const response = await fetch("/PitstopID", fetchConfigData);

			if (response.ok) {
				const data = await response.json();
				sidecarCounter = data.length;
				counterSpan.textContent = sidecarCounter;
				loadSideWithRicette(data);
			}
		} catch (err) {
			console.error("Errore durante il download:", err);
			alert("Impossibile generare menu: " + err.message);
		}
	}

	// LoadMenu
	const btnLoad = document.getElementById('LoadMenu');
	const fileInput = document.createElement('input');
	fileInput.type = 'file';
	fileInput.accept = '.txt';
	btnLoad.addEventListener('click', () => {
		fileInput.click();
	});
	fileInput.addEventListener('change', (event) => {
		const file = event.target.files[0];
		if (file) {
			elaboraSettimana(file);
		}
	});
	async function elaboraSettimana(file) {
		const testo = await file.text();

		const righe = testo.split('\n').map(r => r.trim()).filter(r => r !== "");
		let giorniArray = [];

		let giornoCorrente = null;
		let ii = 0;
		righe.forEach(riga => {
			console.log("analizzo " + riga);
			if (!isNaN(riga)) {
				if (giornoCorrente) giorniArray.push(giornoCorrente);
				giornoCorrente = { Pranzo: "", Cena: "" };
				ii++;
			}
			else if (riga.toLowerCase().startsWith("pranzo:")) {
				giornoCorrente.Pranzo = riga.replace(/pranzo:/i, "").trim();
			}
			else if (riga.toLowerCase().startsWith("cena:")) {
				giornoCorrente.Cena = riga.replace(/cena:/i, "").trim();
			}
		});
		if (giornoCorrente) giorniArray.push(giornoCorrente);
		console.log("finito " + giorniArray);
		const payload = {
			Giorni: giorniArray,
			idd: questaSettimana._id,
			menID: questaSettimana.Menu
		};
		console.log("Dati pronti per l'invio:", payload);

		const controller = new AbortController();
		const timeoutId = setTimeout(() => controller.abort(), 2000);

		const fetchConfigData = {
			method: "POST",
			body: JSON.stringify(payload),
			headers: { "Content-Type": "application/json" }
		};

		try {
			const response = await fetch("/caricaSettimana", fetchConfigData);
			clearTimeout(timeoutId);

			if (response.ok) {
				window.location.href = '/menu';
			} else {
				const errorData = await response.json();
				console.error("Errore Server:", errorData);
				alert("Errore durante il caricamento.");
			}

		} catch (err) {
			if (err.name === 'AbortError') {
				console.error("Timeout: Il server non ha risposto.");
			} else {
				console.error("Errore Generico:", err);
			}
		}
	}

	// genMENU
	document.getElementById("genMENU").addEventListener("click", async (e) => {
		e.preventDefault();

		try {
			const recipeData = {
				settimana: questaSettimana
			};
			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(recipeData),
				headers: { "Content-Type": "application/json" }
			};
			const response = await fetch("/genSett", fetchConfigData);
			if (response.ok) {
				caricaTavola(idSettima);
			}
		} catch (err) {
			console.error("Errore durante il download:", err);
			alert("Impossibile generare menu: " + err.message);
		}
	});

	// dwnMENU
	document.getElementById("dwnMENU").addEventListener("click", async (e) => {
		e.preventDefault();
		try {
			console.log("giorni: " + questaSettimana);
			const data = questaSettimana;
			var lista = [];
			var listaNomi = [];
			if (data.Giorni && Array.isArray(data.Giorni)) {
				data.Giorni.forEach(giorno => {
					if (giorno.Pranzo && giorno.Pranzo.Name) {
						giorno.Pranzo.Ingredienti.forEach(ingred => {
							lista.push(ingred);
						});
					}
					if (giorno.Cena && giorno.Cena.Name) {
						giorno.Cena.Ingredienti.forEach(ingred => {
							lista.push(ingred);
						});
					}
				});
			}
			for (var i = 0; i < lista.length; i++) {
				const ingred = lista[i];
				const recipeData = {
					Id: ingred
				};
				const fetchConfigData = {
					method: "POST",
					body: JSON.stringify(recipeData),
					headers: { "Content-Type": "application/json" }
				};
				const response = await fetch("/NomeIngr", fetchConfigData);
				if (response.ok) {
					const ojIng = await response.json();
					listaNomi.push(ojIng.Name);
				}
			}

			const listaConta = contaRipetizioni(listaNomi);
			popolaLista(listaConta);

		} catch (err) {
			console.error("Errore durante il download:", err);
		}
	});

	function loadTableWithMenus(settimana) {
		const container = document.getElementById("contenitoreMenu");
		container.innerHTML = "";
		const listaGiorni = settimana.Giorni || [];
		if (listaGiorni.length === 0) {
			container.innerHTML = "<p>Nessun giorno pianificato.</p>";
			return;
		}

		listaGiorni.forEach(giorno => {
			container.innerHTML += getTabellaView(giorno);
		});
	}

	function renderRecipeCell(ricetta) {
		const id = ricetta?._id;
		const nome = ricetta?.Name || ricetta?.name;
		const orario = ricetta?.Orario ?? ricetta?.orario ?? 0;
		const prova = ricetta?.Prova;
		const haRicetta = id && nome && nome !== '-';

		if (haRicetta) {
			const classeColore = getColoreBadge(orario);
			const classeProva = getColore(prova);
			const ora = Date.now(); 
			mappaRicette.set(ricetta._id, ricetta);
			return `<div class="badge ${classeColore} ${classeProva} badge-recipe d-inline-flex align-items-stretch p-0"
						 id="tabrecipe-${id}-${ora}"
						 data-id="${id}" 
						 draggable="false">
	
						<div class="drag-handle px-2 d-flex align-items-center" 
							 draggable="true" 
							 ondragstart="iniziaDrag(event, '${id}', '${nome}', 'tabrecipe-${id}-${ora}')">
							 ⋮
						</div>
						<a href="/ricetta/${ricetta._id}" class="px-3 d-flex align-items-center text-reset text-decoration-none">
							${nome}
						</a>
					</div>`;
		} else {
			return `<small class="text-muted">Trascina qui...</small>`;
		}
	}

	function enableDrag(handle) {
		const container = handle.closest('.badge-recipe-container');
		container.setAttribute('draggable', 'true');
	}

	function disableDrag(handle) {
		const container = handle.closest('.badge-recipe-container');
		container.setAttribute('draggable', 'false');
	}

	function getTabellaView(dati) {
		const nomeGiorno = dati.Nome || 'Giorno';
		return `
			<div class="card mb-3">
				<div class="card-header intesta text-white">
					<h5 class="my-0">${nomeGiorno}</h5>
				</div>
				<div class="card-body p-0">
					<table class="table table-bordered mb-0">
						<tbody>
							<tr>
								<td class="fw-bold" style="width: 15%">Pranzo</td>
								<td ondragover="allowDrop(event)" ondragleave="clearDropStyle(event)" ondrop="gestisciDropTabella(event)">
									<div class="recipe-slot" data-map="${map += 1}">
										${renderRecipeCell(dati.Pranzo)}
									</div>
								</td>
							</tr>
							<tr>
								<td class="fw-bold" style="width: 15%">Cena</td>
								<td ondragover="allowDrop(event)" ondragleave="clearDropStyle(event)" ondrop="gestisciDropTabella(event)">
									<div class="recipe-slot" data-map="${map += 1}">
										${renderRecipeCell(dati.Cena)}
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>`;
	}

	const sidecar = document.getElementById("sidecar");
	function loadSideWithRicette(data) {
		const container = document.getElementById("sidecar");
		container.innerHTML = "";

		data.forEach(ricetta => {
			const htmlContent = renderRecipeCell(ricetta); 
			container.innerHTML += htmlContent;
		});
	}

	function allowDrop(e) {
		e.preventDefault();
		e.currentTarget.classList.add("drag-over");
	}

	function clearDropStyle(e) {
		e.currentTarget.classList.remove("drag-over");
	}

	function gestisciDropTabella(e) {
		e.preventDefault();
		const target = e.currentTarget;
		target.classList.remove("drag-over");

		const data = JSON.parse(e.dataTransfer.getData("text/plain"));
		const slot = target.querySelector(".recipe-slot") || target;

		// se nella tabella c'e gia ricetta, rimettila in sidecar  E ELIMINALA DALLA SETTIMANAAAAAA
		const badgeEsistente = slot.querySelector(".badge-recipe");
		if (badgeEsistente) {
			console.log("ce gia qualcosa");
			const oldId = badgeEsistente.getAttribute("data-id");
			const ricetta = mappaRicette.get(oldId);
			const htmlContent = renderRecipeCell(ricetta);
			rimuoviRicetta(ricetta);
			const container = document.getElementById("sidecar");
			container.innerHTML += htmlContent;
		}

		// metti la tua ricetta nello slot E NELLA SETTIMANAAAAA
		const idSpostata = data.id;
		const ricetta = mappaRicette.get(idSpostata);
		const htmlContent = renderRecipeCell(ricetta);
		const mappa = slot.dataset.map;
		
		slot.innerHTML = htmlContent;

		rimuoviRicetta(ricetta);

		inserisciRicetta(idSpostata, mappa);
		// elimina dal precedente
		const originElement = document.getElementById(data.oggetto);
		if (originElement) {
			originElement.remove();
		}

	}

	function iniziaDrag(e, idData, nome, id) {
		const handle = e.currentTarget;
		const contenitoreMappa = handle.closest('[data-map]');
		const mapValue = contenitoreMappa ? contenitoreMappa.dataset.map : null;

		const payload = {
			id: idData,
			name: nome,
			oggetto: id,
			map: mapValue
		};
		e.dataTransfer.setData("text/plain", JSON.stringify(payload));
		const badgeCompleto = handle.closest('.badge-recipe-container');
		if (badgeCompleto) badgeCompleto.classList.add("opacity-50");
	}

	sidecar.ondragover = (e) => e.preventDefault();

	sidecar.ondrop = (e) => {
		e.preventDefault();
		const data = JSON.parse(e.dataTransfer.getData("text/plain"));
		if (e) {
			const ricetta = mappaRicette.get(data.id);
			const htmlContent = renderRecipeCell(ricetta);
			const container = document.getElementById("sidecar");
			container.innerHTML += htmlContent;
			rimuoviRicetta(ricetta);
			const originElement = document.getElementById(data.oggetto);
			if (originElement) {
				originElement.remove();
			}
		}
	};

	function getColoreBadge(orario) {
		const val = parseInt(orario);
		if (val === 1) return "ricetta-pranzo";
		if (val === 2) return "ricetta-cena";
		return "ricetta-unisex";
	}

	function getColore(prova) {
		if (prova === true) return "ricetta-prova";
		if (prova === false) return "";
		return "";
	}

	function rimuoviRicetta(IDricettaDELETE) {
//		console.log("TOLGO ricetta in settimana: " + IDricettaDELETE);
		liberaRicetta(IDricettaDELETE);
		questaSettimana.Giorni.forEach(giorno => {
			if (giorno.Pranzo && giorno.Pranzo._id.toString() === IDricettaDELETE._id.toString()) {
				giorno.Pranzo = null;
//				console.log("pranzo E UGUALE TOLGO; " + IDricettaDELETE._id.toString());
			}
			else if (giorno.Cena && giorno.Cena._id.toString() === IDricettaDELETE._id.toString()) {
				giorno.Cena = null;
//				console.log("ce4na E UGUALE TOLGO; " + IDricettaDELETE._id.toString());
			}
		});
	}

	function inserisciRicetta(IDricettaADD, codice) {
		console.log("metto ricetta in settimana: " + IDricettaADD + " mappa " + codice);
		occupaRicetta(IDricettaADD);
		const indiceGiorno = Math.floor((codice - 1) / 2);
		const tipoPasto = (codice % 2 !== 0) ? 'Pranzo' : 'Cena';
		const giorno = questaSettimana.Giorni[indiceGiorno];

		if (giorno) {
			giorno[tipoPasto] = mappaRicette.get(IDricettaADD);
		}
	}

	async function liberaRicetta(IDricetta) {
		try {
			const payload = {
				_id: IDricetta,
				_idMen: idMenu
			}
			const controller = new AbortController();
			const timeoutId = setTimeout(() => controller.abort(), 2000);

			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(payload),
				headers: { "Content-Type": "application/json" }
			};

			const response = await fetch("/liberaRicetta", fetchConfigData);
			clearTimeout(timeoutId);

			if (response.ok) {
				sidecarCounter += 1;
				counterSpan.textContent = sidecarCounter;
			} else {
				console.error(`Errore del server: ${response.status}`);
			}

		} catch (error) {
			console.error('Errore durante la liberazione:', error);
		}
	}

	async function occupaRicetta(IDricetta) {
		try {
			const payload = {
				_id: IDricetta,
				_idMen: idMenu
			}
			const controller = new AbortController();
			const timeoutId = setTimeout(() => controller.abort(), 2000);

			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(payload),
				headers: { "Content-Type": "application/json" }
			};

			const response = await fetch("/occupaRicetta", fetchConfigData);
			clearTimeout(timeoutId);

			if (response.ok) {
				sidecarCounter -= 1;
				counterSpan.textContent = sidecarCounter;
			} else {
				console.error(`Errore del server: ${response.status}`);
			}

		} catch (error) {
			console.error('Errore durante l associazione:', error);
		}
	}

	async function salvaSettimana() {
		try {
			const payload = questaSettimana;
			const controller = new AbortController();
			const timeoutId = setTimeout(() => controller.abort(), 2000);

			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(payload),
				headers: { "Content-Type": "application/json" }
			};

			const response = await fetch("/salvaSettimana", fetchConfigData);
			clearTimeout(timeoutId);

			if (response.ok) {
				alert('Modifiche salvate correttamente.');
			} else {
				console.error(`Errore del server: ${response.status}`);
			}

		} catch (error) {
			console.error('Errore durante il salvataggio:', error);
			alert('Si è verificato un errore durante il salvataggio.');
		}
	}

	// Save
	document.getElementById("Save").addEventListener("click", async (e) => {
		e.preventDefault();

		try {
			salvaSettimana();
		} catch (err) {
			console.error("Errore durante salvataggio", err);
		}
	});

	async function refresh() {
		try {
			const payload = {};
			const controller = new AbortController();
			const timeoutId = setTimeout(() => controller.abort(), 2000);

			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(payload),
				headers: { "Content-Type": "application/json" }
			};

			const response = await fetch("/refreshRic", fetchConfigData);
			clearTimeout(timeoutId);

			if (response.ok) {
			} else {
				console.error(`Errore del server: ${response.status}`);
			}

		} catch (error) {
			console.error('Errore durante la pulizia:', error);
			alert('Si è verificato un errore durante la pulizia.');
		}
	}

	// fresh
	document.getElementById("fresh").addEventListener("click", async (e) => {
		e.preventDefault();

		try {
			console.log("pulisco: ");
			refresh();
		} catch (err) {
			console.error("Errore durante salvataggio", err);
		}
	});
</script>
