<a href="/menu" class="btn btn-primary mb-3">Vai ai Menu</a>
<a href="/ricette" class="btn btn-secondary mb-3">Vai alle Ricette</a>
<a href="/ingredienti" class="btn btn-secondary mb-3">Vai agli Ingredienti</a>
<button id="dwnMENU" class="btn btn-secondary mb-3">Scarica MENU</button>
<h2 class="display-4">Ecco il tuo menu</h2>
<p>
	<h3 id="intestazione">Name per l'Temperatura</h3>
</p>

<div id="contenitoreMenu">
</div>


<script>
	document.addEventListener("DOMContentLoaded", (event) => {
		const url = window.location.pathname;
		const segments = url.split('/');
		const id = segments.pop();
		caricaTavola(id);
	});
	var name = "";
	var menuu = "";

	async function caricaTavola(id) {
		try {

			const recipeData = {
				_id: id,
			};
			const fetchConfigData = {
				method: "POST",
				body: JSON.stringify(recipeData),
				headers: { "Content-Type": "application/json" }
			};
			const response = await fetch("/pian", fetchConfigData);
			if (response.ok) {
				const mens = await response.json();
				menuu = mens;
				var div = document.getElementById("intestazione");
				div.innerHTML = div.innerHTML.replace("Name", mens.Name);
				var temper = "";
				name = mens.Name;
				switch (mens.Temperatura) {
					case 1:
						temper = 'Estate';
						break;
					case 2:
						temper = 'Inverno';
						break;
					default:
						temper = 'OgniStagione';
				}

				div.innerHTML = div.innerHTML.replace("Temperatura", temper);
				loadTableWithMenus((mens));
			} else {
				console.log("Error with the response data");
			}
		} catch (err) {
			console.log(`Error: ${err}`);
		}
	}

	document.getElementById("dwnMENU").addEventListener("click", async (e) => {
		e.preventDefault();

		try {
			const data = menuu;
			const decodeHTML = (html) => {
				const txt = document.createElement("textarea");
				txt.innerHTML = html;
				return txt.value;
			};
			let textContent = "";
			if (data.Name) {
				textContent += `${data.Name}\n\n`;
			}
			if (data.Giorni && Array.isArray(data.Giorni)) {
				data.Giorni.forEach(giorno => {
					const nomeGiorno = decodeHTML(giorno.Nome || "");
					textContent += `${nomeGiorno}\n`;
					textContent += `\tPranzo:\n`;
					if (giorno.Pranzo && giorno.Pranzo.Name) {
						textContent += `\t\t${giorno.Pranzo.Name}\n`;
					} else {
						textContent += `\t\t-\n`;
					}
					textContent += `\tCena:\n`;
					if (giorno.Cena && giorno.Cena.Name) {
						textContent += `\t\t${giorno.Cena.Name}\n`;
					} else {
						textContent += `\t\t-\n`;
					}
					textContent += `\n`;
				});
			}

			const blob = new Blob([textContent], { type: "text/plain" });
			const url = URL.createObjectURL(blob);
			const link = document.createElement('a');
			link.href = url;
			link.download = `${data.Name || 'menu'}.txt`;
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
			URL.revokeObjectURL(url);
		} catch (err) {
			console.error("Errore durante il download:", err);
			alert("Impossibile scaricare il file TXT: " + err.message);
		}
	});

	function loadTableWithMenus(menu) {
		const container = document.getElementById("contenitoreMenu");
		container.innerHTML = "";
		const listaGiorni = menu.Giorni || [];
		if (listaGiorni.length === 0) {
			container.innerHTML = "<p>Nessun giorno pianificato.</p>";
			return;
		}

		listaGiorni.forEach(giorno => {
			container.innerHTML += getTabellaView(giorno);
		});
	}

	function getTabellaView(dati) {
		const nomePranzo = dati.Pranzo ? dati.Pranzo.Name : '-';
		const nomeCena = dati.Cena ? dati.Cena.Name : '-';
		const nomeGiorno = dati.Nome || 'Giorno';

		return `
	<div class="card mb-3">
		<div class="card-header bg-info text-white">
			<h5 class="my-0">${nomeGiorno}</h5> 
		</div>
		<div class="card-body p-0">
			<table class="table table-bordered mb-0">
				<thead>
					<tr>
						<th style="width: 50%">Pranzo</th>
						<th style="width: 50%">Cena</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<td>${nomePranzo}</td>
						<td>${nomeCena}</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	`;
	}
</script>
